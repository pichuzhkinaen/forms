(function(a){a.fn.waterwheelCarousel=function(q){if(this.length>1){this.each(function(){a(this).waterwheelCarousel(q)});return this}var l=this;var c={};var s={};function i(){s={itemsContainer:a(l),totalItems:a(l).children().length,containerWidth:a(l).width(),containerHeight:a(l).height(),currentCenterItem:null,previousCenterItem:null,items:[],calculations:[],carouselRotationsLeft:0,currentlyMoving:false,itemsAnimating:0,currentSpeed:c.speed,intervalTimer:null,currentDirection:"forward",leftItemsCount:0,rightItemsCount:0,performingSetup:true};s.itemsContainer.find("img").removeClass(c.activeClassName)}function k(t){clearTimeout(s.autoPlayTimer);if(!t&&c.autoPlay!==0){s.autoPlayTimer=setTimeout(function(){if(c.autoPlay>0){m("forward")}else{m("backward")}},Math.abs(c.autoPlay))}}function g(w){var u=s.itemsContainer.find("img"),t=0,v=u.length;u.each(function(){a(this).bind("load",function(){t+=1;if(t===v){w();return}});a(this).attr("src")==a(this).attr("src");if(this.complete){a(this).trigger("load")}})}function d(){s.itemsContainer.find("img").each(function(){if(a(this).data("original_width")==undefined){a(this).data("original_width",a(this).width())}if(a(this).data("original_height")==undefined){a(this).data("original_height",a(this).height())}})}function r(){var u=s.itemsContainer.find("img:first");s.calculations[0]={distance:0,offset:0,width:u.data("original_width"),height:u.data("original_height"),opacity:1};var t=c.horizonOffset;var w=c.separation;for(var v=1;v<=c.flankingItems+2;v++){if(v>1){t*=c.horizonOffsetMultiplier;w*=c.separationMultiplier}s.calculations[v]={distance:s.calculations[v-1].distance+w,offset:s.calculations[v-1].offset+t,width:s.calculations[v-1].width*c.sizeMultiplier,height:s.calculations[v-1].height*c.sizeMultiplier,opacity:s.calculations[v-1].opacity*c.opacityMultiplier}}s.calculations[c.flankingItems+1].opacity=0}function b(){s.items=s.itemsContainer.find("img");for(var t=0;t<s.totalItems;t++){s.items[t]=a(s.items[t])}if(c.horizon===0){if(c.orientation==="horizontal"){c.horizon=s.containerHeight/2}else{c.horizon=s.containerWidth/2}}s.itemsContainer.css("position","relative").find("img").each(function(u){var w,v;if(c.orientation==="horizontal"){w=(s.containerWidth/2)-(a(this).width()/2);v=c.horizon-(a(this).height()/2)}else{w=c.horizon-(a(this).width()/2);v=(s.containerHeight/2)-(a(this).height()/2)}a(this).css({left:w,top:v,visibility:"visible",position:"absolute","z-index":c.flankingItems+2,opacity:1}).data({currentPosition:0,oldPosition:0,width:a(this).width(),height:a(this).height(),top:v,left:w,opacity:1}).show()})}function p(){c.startingItem=(c.startingItem===0)?Math.round(s.totalItems/2):c.startingItem;s.rightItemsCount=Math.ceil((s.totalItems-1)/2);s.leftItemsCount=Math.floor((s.totalItems-1)/2);s.carouselRotationsLeft=1;j(s.items[c.startingItem-1],0);var t=c.startingItem-1;for(var u=1;u<=s.rightItemsCount;u++){(t<s.totalItems-1)?t+=1:t=0;j(s.items[t],u)}var t=c.startingItem-1;for(var u=-1;u>=s.leftItemsCount*-1;u--){(t>0)?t-=1:t=s.totalItems-1;j(s.items[t],u)}}function e(G,x){if(Math.abs(x)<c.flankingItems+1){var w=s.calculations[Math.abs(x)]}else{var w=s.calculations[c.flankingItems+1]}var y=Math.abs(x);var z=w.width;var v=w.height;var u=Math.abs(G.data().width-z);var A=Math.abs(G.data().height-v);var B=w.offset;var H=w.distance;if(x<0){H*=-1}if(c.orientation=="horizontal"){var t=s.containerWidth/2;var F=t+H-(z/2);var D=c.horizon-B-(v/2)}else{var t=s.containerHeight/2;var F=c.horizon-B-(z/2);var D=t+H-(v/2)}var C;if(x===0){C=1}else{C=w.opacity}var E=c.flankingItems+2-y;G.data("width",z);G.data("height",v);G.data("top",D);G.data("left",F);G.data("oldPosition",G.data("currentPosition"));G.data("depth",E);G.data("opacity",C)}function j(t,u){e(t,u);if(Math.abs(u)<=c.flankingItems+1){s.itemsAnimating++;t.css("z-index",t.data().depth).animate({left:t.data().left,width:t.data().width,height:t.data().height,top:t.data().top,opacity:t.data().opacity},s.currentSpeed,c.animationEasing,function(){f(t,u)})}else{t.data("currentPosition",u);if(t.data("oldPosition")===0){t.css({left:t.data().left,width:t.data().width,height:t.data().height,top:t.data().top,opacity:t.data().opacity,"z-index":t.data().depth})}}}function f(t,u){s.itemsAnimating--;t.data("currentPosition",u);if(u===0){s.currentCenterItem=t}if(s.itemsAnimating===0){s.carouselRotationsLeft-=1;s.currentlyMoving=false;if(s.carouselRotationsLeft>0){o(0)}else{s.currentSpeed=c.speed;s.currentCenterItem.addClass(c.activeClassName);if(s.performingSetup===false){c.movedToCenter(s.currentCenterItem);c.movedFromCenter(s.previousCenterItem)}s.performingSetup=false;k()}}}function o(u){if(s.currentlyMoving===false){s.currentCenterItem.removeClass(c.activeClassName);s.currentlyMoving=true;s.itemsAnimating=0;s.carouselRotationsLeft+=u;if(c.quickerForFurther===true){if(u>1){s.currentSpeed=c.speed/u}s.currentSpeed=(s.currentSpeed<100)?100:s.currentSpeed}for(var x=0;x<s.totalItems;x++){var v=a(s.items[x]);var y=v.data("currentPosition");var w;if(s.currentDirection=="forward"){w=y-1}else{w=y+1}var t=(w>0)?s.rightItemsCount:s.leftItemsCount;if(Math.abs(w)>t){w=y*-1;if(s.totalItems%2==0){w+=1}}j(v,w)}}}a(this).find("img").bind("click",function(){var u=a(this).data().currentPosition;if(Math.abs(u)>=c.flankingItems+1){return}if(s.currentlyMoving){return}s.previousCenterItem=s.currentCenterItem;k(true);var t=Math.abs(u);if(u==0){c.clickedCenter(a(this))}else{c.movingFromCenter(s.currentCenterItem);c.movingToCenter(a(this));if(u<0){s.currentDirection="backward";o(t)}else{if(u>0){s.currentDirection="forward";o(t)}}}});a(this).find("a").bind("click",function(t){var u=a(this).find("img").data("currentPosition")==0;if(c.linkHandling===1||(c.linkHandling===2&&!u)){t.preventDefault();return false}});function n(){var t=s.currentCenterItem.next();if(t.length<=0){t=s.currentCenterItem.parent().children().first()}return t}function h(){var t=s.currentCenterItem.prev();if(t.length<=0){t=s.currentCenterItem.parent().children().last()}return t}function m(t){if(s.currentlyMoving===false){s.previousCenterItem=s.currentCenterItem;c.movingFromCenter(s.currentCenterItem);if(t=="backward"){c.movingToCenter(h());s.currentDirection="backward"}else{if(t=="forward"){c.movingToCenter(n());s.currentDirection="forward"}}}o(1)}a(document).keydown(function(t){if(c.keyboardNav){if((t.which===37&&c.orientation=="horizontal")||(t.which===38&&c.orientation=="vertical")){k(true);c.autoPlay=0;m("backward")}else{if((t.which===39&&c.orientation=="horizontal")||(t.which===40&&c.orientation=="vertical")){k(true);c.autoPlay=0;m("forward")}}if(c.keyboardNavOverride&&((c.orientation=="horizontal"&&(t.which===37||t.which===39))||(c.orientation=="vertical"&&(t.which===38||t.which===40)))){t.preventDefault();return false}}});this.reload=function(u){if(typeof u==="object"){var t=u}else{var t={}}c=a.extend({},a.fn.waterwheelCarousel.defaults,u);i();s.itemsContainer.find("img").hide();g(function(){d();r();b();p()})};this.next=function(){k(true);c.autoPlay=0;m("forward")};this.prev=function(){k(true);c.autoPlay=0;m("backward")};this.reload(q);return this};a.fn.waterwheelCarousel.defaults={startingItem:1,separation:175,separationMultiplier:0.6,horizonOffset:0,horizonOffsetMultiplier:1,sizeMultiplier:0.7,opacityMultiplier:0.8,horizon:0,flankingItems:3,speed:300,animationEasing:"linear",quickerForFurther:true,linkHandling:2,autoPlay:0,orientation:"horizontal",activeClassName:"carousel-center",keyboardNav:false,keyboardNavOverride:true,movingToCenter:a.noop,movedToCenter:a.noop,clickedCenter:a.noop,movingFromCenter:a.noop,movedFromCenter:a.noop}})(jQuery);